version: '3.8'

# ============================================================================
# VOSTOK-1 INFRASTRUCTURE - Fase 1
# Arquiteto: Petrovich | Operador: Vostok
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # REDIS 7 (Alpine) - Event Bus / Hot Storage
  # Configurado para persistência AOF (Append-Only File)
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: vostok_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    volumes:
      - vostok_redis_data:/data
    networks:
      - vostok_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --------------------------------------------------------------------------
  # TIMESCALEDB (PostgreSQL 16) - Cold Storage / Time Series / Vector Store
  # Com suporte a PGVector para embeddings do módulo Sentimento_AI
  # --------------------------------------------------------------------------
  timescaledb:
    image: timescale/timescaledb-ha:pg16
    container_name: vostok_timescale
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: vostok
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vostok_secure_2024}
      POSTGRES_DB: vostok_trading
    volumes:
      - vostok_timescale_data:/home/postgres/pgdata/data
      - ./scripts/init-db:/docker-entrypoint-initdb.d:ro
    networks:
      - vostok_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vostok -d vostok_trading"]
      interval: 10s
      timeout: 5s
      retries: 5
    shm_size: 256mb

  # --------------------------------------------------------------------------
  # INGESTOR - Captura de trades via WebSocket (Binance -> Redis Streams)
  # --------------------------------------------------------------------------
  ingestor:
    build:
      context: .
      dockerfile: Dockerfile.ingestor
    container_name: vostok_ingestor
    restart: unless-stopped
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_STREAM: stream:market:btc_usdt
      SYMBOL: BTC/USDT
      EXCHANGE_ID: binance
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - vostok_net
    # Sem porta exposta - comunicação apenas via Redis

  # --------------------------------------------------------------------------
  # QUANT - Agregação OHLCV + Indicadores Técnicos (TA-Lib)
  # --------------------------------------------------------------------------
  quant:
    build:
      context: .
      dockerfile: Dockerfile.quant
    container_name: vostok_quant
    restart: unless-stopped
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      INPUT_STREAM: stream:market:btc_usdt
      OUTPUT_STREAM: stream:signals:tech
      CONSUMER_GROUP: quant_group
      CONSUMER_NAME: quant_worker_1
    depends_on:
      redis:
        condition: service_healthy
      ingestor:
        condition: service_started
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # DECISION - Data Labeling Engine (Triple Barrier)
  # --------------------------------------------------------------------------
  decision:
    build:
      context: .
      dockerfile: Dockerfile.decision
    container_name: vostok_decision
    restart: unless-stopped
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SIGNAL_STREAM: stream:signals:tech
      MARKET_STREAM: stream:market:btc_usdt
      CONSUMER_GROUP: decision_group
      CONSUMER_NAME: decision_worker_1
      DATA_DIR: /app/data
    volumes:
      - ./data:/app/data
    depends_on:
      redis:
        condition: service_healthy
      quant:
        condition: service_started
    networks:
      - vostok_net

# ============================================================================
# VOLUMES (Nomeados para evitar problemas de permissão)
# ============================================================================
volumes:
  vostok_redis_data:
    name: vostok_redis_data
  vostok_timescale_data:
    name: vostok_timescale_data

# ============================================================================
# NETWORK
# ============================================================================
networks:
  vostok_net:
    driver: bridge
    name: vostok_net

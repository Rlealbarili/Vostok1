# ============================================================================
# VOSTOK-1 :: Docker Compose Orchestration
# Sistema de Trading Autônomo com Data Labeling e TUI Monitor
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # REDIS 7 (Alpine) - Event Bus / Stream Central
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: vostok_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 512mb 
      --maxmemory-policy allkeys-lru
    volumes:
      - vostok_redis_data:/data
    networks:
      - vostok_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------------------------
  # TIMESCALEDB (PostgreSQL 16) - Cold Storage / Time Series
  # --------------------------------------------------------------------------
  timescaledb:
    image: timescale/timescaledb-ha:pg16
    container_name: vostok_timescale
    restart: unless-stopped
    ports:
      - "5433:5432"
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-vostok}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vostok_secure_2024}
      POSTGRES_DB: ${POSTGRES_DB:-vostok_trading}
    volumes:
      - vostok_timescale_data:/home/postgres/pgdata/data
      - ./scripts/init-db:/docker-entrypoint-initdb.d:ro
    networks:
      - vostok_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vostok -d vostok_trading"]
      interval: 10s
      timeout: 5s
      retries: 5
    shm_size: 256mb

  # --------------------------------------------------------------------------
  # INGESTOR - WebSocket (Binance -> Redis)
  # --------------------------------------------------------------------------
  ingestor:
    build:
      context: .
      dockerfile: Dockerfile.ingestor
    container_name: vostok_ingestor
    restart: unless-stopped
    env_file:
      - .env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_STREAM: stream:market:btc_usdt
      SYMBOL: ${SYMBOL:-BTC/USDT}
      EXCHANGE_ID: ${EXCHANGE_ID:-binance}
      BINANCE_API_KEY: ${BINANCE_API_KEY}
      BINANCE_API_SECRET: ${BINANCE_API_SECRET}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # QUANT - OHLCV + Indicadores Técnicos + Live Pulse
  # --------------------------------------------------------------------------
  quant:
    build:
      context: .
      dockerfile: Dockerfile.quant
    container_name: vostok_quant
    restart: unless-stopped
    env_file:
      - .env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      INPUT_STREAM: stream:market:btc_usdt
      OUTPUT_STREAM: stream:signals:tech
      LIVE_STREAM: stream:signals:live
      CONSUMER_GROUP: quant_group
      CONSUMER_NAME: quant_worker_1
    depends_on:
      redis:
        condition: service_healthy
      ingestor:
        condition: service_started
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # DECISION - Data Labeling Engine (Triple Barrier)
  # --------------------------------------------------------------------------
  decision:
    build:
      context: .
      dockerfile: Dockerfile.decision
    container_name: vostok_decision
    restart: unless-stopped
    env_file:
      - .env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SIGNAL_STREAM: stream:signals:tech
      MARKET_STREAM: stream:market:btc_usdt
      CONSUMER_GROUP: decision_group
      CONSUMER_NAME: decision_worker_1
      DATA_DIR: /app/data
    volumes:
      - ./data/training:/app/data/training
    depends_on:
      redis:
        condition: service_healthy
      quant:
        condition: service_started
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # MONITOR - TUI Dashboard (Rich) - Lê stream:signals:live
  # --------------------------------------------------------------------------
  monitor:
    build:
      context: .
      dockerfile: Dockerfile.monitor
    container_name: vostok_monitor
    stdin_open: true
    tty: true
    env_file:
      - .env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SIGNAL_STREAM: stream:signals:tech
      LIVE_STREAM: stream:signals:live
      DATA_DIR: /app/data
      TERM: xterm-256color
      TZ: America/Sao_Paulo
    volumes:
      - ./data/training:/app/data/training:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # TRAINER - ML Training (RandomForest)
  # --------------------------------------------------------------------------
  trainer:
    build:
      context: .
      dockerfile: Dockerfile.trainer
    container_name: vostok_trainer
    env_file:
      - .env
    environment:
      DATA_DIR: /app/data
      MODELS_DIR: /app/models
    volumes:
      - ./data/training:/app/data/training:ro
      - ./models:/app/models
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # SENTIMENT - LLM-Powered News Sentiment Analysis
  # --------------------------------------------------------------------------
  sentiment:
    build:
      context: .
      dockerfile: Dockerfile.sentiment
    container_name: vostok_sentiment
    restart: unless-stopped
    env_file:
      - .env
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SENTIMENT_STREAM: stream:signals:sentiment
      OLLAMA_HOST: llm_engine
      OLLAMA_PORT: 11434
      LLM_MODEL: qwen2.5:7b-instruct
      ANALYSIS_INTERVAL: 900
    depends_on:
      redis:
        condition: service_healthy
      llm_engine:
        condition: service_healthy
    networks:
      - vostok_net

  # --------------------------------------------------------------------------
  # LLM ENGINE - Ollama (Local LLM for Sentiment Analysis)
  # GPU 0 = Dedicada/Livre | GPU 1 = Desktop (ocupada)
  # --------------------------------------------------------------------------
  llm_engine:
    image: ollama/ollama:latest
    container_name: vostok_llm
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_KEEP_ALIVE=24h
    networks:
      - vostok_net
    # GPU Support - TRAVADO NA GPU 0 (livre)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    # Healthcheck
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  vostok_redis_data:
    name: vostok_redis_data
  vostok_timescale_data:
    name: vostok_timescale_data
  ollama_data:
    name: vostok_ollama_data

# ============================================================================
# NETWORK
# ============================================================================
networks:
  vostok_net:
    driver: bridge
    name: vostok_net
